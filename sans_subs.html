<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>MQTT Publish</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js" type="text/javascript"></script>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <style>
            .container{
            width:500px;
            height:210px;
            padding:20px;
            /* background:#5e6e02; */
            background: linear-gradient(to top, #009999 0%, #666699 100%);
            position: fixed;
            top: 50%;
            left: 50%;
            margin-top: -220px;
            margin-left: -250px;
            border-radius:10px !important;
            font-family:monospace;
            }
            b{
                color:white;
                font-size:13px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2 style="text-align:center;color:white;font-weight:bold;font-size:30px;">Bandung Weather News (output)</h2><!-- // ubah aja ini jadi yg sesuai -->
            <form id="connection-info-form" style="text-align:center;">
                <b style="display:inline-block; width: 100px;">Hostname:</b>
                <input style="border-radius:10px" id="host" type="text" name="host" value="broker.hivemq.com"><br>
                <b style="display:inline-block; width: 100px;">Port:</b>
                <input style="border-radius:10px" id="port" type="text" name="port  " value="8000"><br>
                <b style="display:inline-block; width: 100px;">Topic:</b>
                <input style="border-radius:10px"id="topic" type="text" name="topic" value="suhuBDG"><br><br><br>
                <input type="button" class="btn btn-outline-info btn-sm" onclick="startConnect()" value="Connect">
                <input type="button" class="btn btn-outline-secondary btn-sm" onclick="startDisconnect()" value="Disconnect">
            </form>
            <div id="messages">
            </div>
        </div>
        <script type="text/javascript">

            function startConnect() {
                clientID = "clientID_" + parseInt(Math.random() * 100);

                host = document.getElementById("host").value;
                port = document.getElementById("port").value;
               
                document.getElementById("messages").innerHTML += '<span>Connecting to: ' + host + ' on port: ' + port + '</span><br/>';
                document.getElementById("messages").innerHTML += '<span>Using the following client value: ' + clientID + '</span><br/>';
                

                // Initialize new Paho client connection
                client = new Paho.MQTT.Client(host, Number(port), clientID);

                // Set callback handlers
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;

                // Connect the client, if successful, call onConnect function
                client.connect({onSuccess: onConnect});
            }

            function onConnect(){
                console.log("onConnect");
                // Fetch the MQTT topic from the form
                topic = document.getElementById("topic").value;

                // Print output for the user in the messages div
                document.getElementById("messages").innerHTML += '<span>Subscribing to: ' + topic + '</span><br/>';

                client.subscribe(topic);

                // pesan_sub = new Paho.MQTT.message(pesan);
                // pesan_sub.destinationName = topic;
                // client.send(pesan_sub);
            }

            // Called when the client loses its connection
            function onConnectionLost(responseObject) {
                document.getElementById("messages").innerHTML += '<span>ERROR: Connection lost</span><br/>';
                if (responseObject.errorCode !== 0) {
                document.getElementById("messages").innerHTML += '<span>ERROR: ' + + responseObject.errorMessage + '</span><br/>';
                }
            }

            // Called when a message arrives
            function onMessageArrived(message) {
                console.log("onMessageArrived: " + message.payloadString);
                document.getElementById("messages").innerHTML += '<span>Topic: ' + message.destinationName + '  | ' + message.payloadString + '</span><br/>';
                a = message.payloadString; //message yg ditarik
                b = a.split("|"); // split
                var data1 = parseFloat(b[0]); //convert to float
                var data2 = parseFloat(b[1]);
                var data3 = parseFloat(b[2]);
               //  var dnul = 0;
               //  if (data1 = 0){
               //    d1 = 1;
               //  }
               //  if (data2 = 0){
               //    d2 = 1;
               //  }
               //  if (data3 = 0){
               //    d3 = 1;
               //  }
               //  dnul = d1+d2+d3;
               //
               // document.getElementById("messages").innerHTML += 'nol= '+dnul;

                // var i;
                //   for (i = 0; i < b.length; i++) {
                //     if (b[i] = 0){
                //       dnol += i + dnol "<br>"; //detect null
                //     }
                //   }
          //      document.getElementById("messages").innerHTML += 'nol ada berapa= '+dnol;
                document.getElementById("messages").innerHTML += data1;
                document.getElementById("messages").innerHTML += data2;
                document.getElementById("messages").innerHTML += data3;

                var jum = data1+data2+data3;
                var rata = 0;
                document.getElementById("messages").innerHTML += 'hasil= '+jum;
           
            }

            // Called when the disconnection button is pressed
            function startDisconnect() {
                client.disconnect();
                document.getElementById("messages").innerHTML += '<span>Disconnected</span><br/>';
            }

        </script>
    </body>
</html>
